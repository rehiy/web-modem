<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modem 调测系统</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-title">
                <h1>📱 Modem 调测系统</h1>
            </div>
            <div class="header-controls">
                <nav class="nav-tabs">
                    <button class="nav-tab active" data-tab="main" onclick="app.tabManager.switchTab('main')">主界面</button>
                    <button class="nav-tab" data-tab="sms" onclick="app.tabManager.switchTab('sms')">短信收发</button>
                    <button class="nav-tab" data-tab="smsdb" onclick="app.tabManager.switchTab('smsdb')">短信存储</button>
                    <button class="nav-tab" data-tab="webhook" onclick="app.tabManager.switchTab('webhook')">Webhook</button>
                </nav>
                <div class="control-group">
                    <select class="form-select" id="modemSelect" onchange="app.tabManager.switchModem()">
                        <option value="">-- 选择串口 --</option>
                    </select>
                    <button class="btn btn-primary" onclick="app.modemManager.refreshModems()">刷新设备</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">

            <!-- 主界面 -->
            <div id="mainTab" class="tab-content active">

                <!-- Modem 信息 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Modem 信息</h2>
                        <div>
                            <button class="btn btn-secondary" onclick="app.modemManager.getSignalStrength()">刷新信号</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="info-grid" id="modemInfo">
                            <div class="info-item">
                                <span class="info-label">串口</span>
                                <span class="info-value">{info.name}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">制造商</span>
                                <span class="info-value">{info.manufacturer}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">型号</span>
                                <span class="info-value">{info.model}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">IMEI</span>
                                <span class="info-value">{info.imei}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">手机号</span>
                                <span class="info-value">{info.number}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">运营商</span>
                                <span class="info-value">{info.operator}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">短信模式</span>
                                <span class="info-value">{info.sms_mode}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">短信中心</span>
                                <span class="info-value">{info.sms_center}</span>
                            </div>
                        </div>
                        <div class="info-grid mt-1" id="signalInfo">
                            <div class="info-item">
                                <span class="info-label">信号等级</span>
                                <span class="info-value">{signal.level}%</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">信号强度</span>
                                <span class="info-value">{signal.rssi}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">dBm</span>
                                <span class="info-value">{signal.dbm}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AT 命令终端 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">AT 命令终端</h2>
                        <span class="flex-auto"></span>
                        <select class="form-select" onchange="app.modemManager.onATCommandSelect(this.value)">
                            <option value="">-- 选择快捷指令 --</option>
                            <optgroup label="基本控制">
                                <option value="AT">AT - 测试连接</option>
                                <option value="ATE0">ATE0 - 关闭回显</option>
                                <option value="ATE1">ATE1 - 开启回显</option>
                                <option value="ATZ">ATZ - 重置 modem</option>
                                <option value="AT&F">AT&F - 恢复出厂设置</option>
                                <option value="AT&W">AT&W - 保存设置</option>
                            </optgroup>
                            <optgroup label="设备身份信息">
                                <option value="AT+CGSN">AT+CGSN - 查询 IMEI</option>
                                <option value="AT+CGMI">AT+CGMI - 查询制造商</option>
                                <option value="AT+CGMM">AT+CGMM - 查询型号</option>
                                <option value="AT+CGMR">AT+CGMR - 查询版本</option>
                                <option value="AT+CIMI">AT+CIMI - 查询 IMSI</option>
                                <option value="AT+CCID">AT+CCID - 查询 ICCID</option>
                                <option value="AT+CNUM">AT+CNUM - 查询本机号码</option>
                            </optgroup>
                            <optgroup label="网络状态">
                                <option value="AT+COPS">AT+COPS - 查询/设置运营商</option>
                                <option value="AT+CNMP">AT+CNMP - 查询/设置网络模式</option>
                                <option value="AT+CREG">AT+CREG - 查询网络注册状态</option>
                                <option value="AT+CGREG">AT+CGREG - 查询 GPRS 注册状态</option>
                                <option value="AT+CSQ">AT+CSQ - 查询信号质量</option>
                            </optgroup>
                            <optgroup label="SIM 卡管理">
                                <option value="AT+CPIN">AT+CPIN - 查询 SIM 卡状态</option>
                                <option value="AT+CPWD">AT+CPWD - 修改 PIN 码</option>
                                <option value="AT+CLCK">AT+CLCK - 查询/设置 PIN 锁</option>
                            </optgroup>
                            <optgroup label="设备状态">
                                <option value="AT+CBC">AT+CBC - 查询电池电量</option>
                                <option value="AT+CPMUTEMP">AT+CPMUTEMP - 查询设备温度</option>
                                <option value="AT+CCLK">AT+CCLK - 查询/设置网络时间</option>
                            </optgroup>
                            <optgroup label="网络配置">
                                <option value="AT+CGDCONT">AT+CGDCONT - 查询/设置 APN</option>
                                <option value="AT+CGPADDR">AT+CGPADDR - 查询 IP 地址</option>
                                <option value="AT+CGACT">AT+CGACT - 查询/设置 PDP 上下文</option>
                            </optgroup>
                            <optgroup label="短信相关">
                                <option value="AT+CMGF">AT+CMGF - 查询/设置短信格式</option>
                                <option value="AT+CPMS">AT+CPMS - 查询/设置短信存储位置</option>
                                <option value="AT+CSCA">AT+CSCA - 查询/设置短信中心号码</option>
                                <option value="AT+CMGL">AT+CMGL - 列出短信</option>
                                <option value="AT+CMGR">AT+CMGR - 读取短信</option>
                                <option value="AT+CMGD">AT+CMGD - 删除短信</option>
                                <option value="AT+CMGS">AT+CMGS - 发送短信</option>
                            </optgroup>
                            <optgroup label="语音通话">
                                <option value="ATD">ATD - 拨号</option>
                                <option value="ATA">ATA - 接听</option>
                                <option value="ATH">ATH - 挂断</option>
                                <option value="AT+CLIP">AT+CLIP - 查询/设置来电显示</option>
                                <option value="AT+CLCC">AT+CLCC - 查询通话状态</option>
                                <option value="AT+CCWA">AT+CCWA - 查询/设置呼叫等待</option>
                                <option value="AT+CCFC">AT+CCFC - 查询/设置呼叫转移</option>
                            </optgroup>
                        </select>
                        <span>&nbsp; &nbsp;</span>
                        <button class="btn btn-primary" onclick="app.modemManager.sendATCommand()">发送指令</button>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <input type="text" class="form-input" id="atCommand" placeholder="输入 AT 命令 (例如: AT+CGMI)">
                        </div>
                        <div class="terminal" id="terminal"></div>
                    </div>
                </div>

            </div>

            <!-- 短信收发 -->
            <div id="smsTab" class="tab-content">

                <!-- 接收短信 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">接收短信</h2>
                        <button class="btn btn-secondary" onclick="app.modemManager.listSms()">刷新列表</button>
                    </div>
                    <div class="card-body">
                        <div class="scroll-container" id="smsList">
                            <div class="sms-item">
                                <div class="sms-header">
                                    <span class="sms-number">📱 {sms.number} &nbsp;</span>
                                    <span class="sms-time">🕐 {sms.time} &nbsp;</span>
                                    <span class="flex-auto"></span>
                                    <button class="btn btn-small btn-danger" onclick="app.modemManager.deleteSms({sms.indices})">删除</button>
                                </div>
                                <div class="sms-message">{sms.text}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 发送短信 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">发送短信</h2>
                        <button class="btn btn-primary" onclick="app.modemManager.sendSms()">发送短信</button>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">收件人号码</label>
                            <input type="text" class="form-input" id="smsNumber" placeholder="+86XXXXXXXXXXX">
                        </div>
                        <div class="form-group">
                            <label class="form-label">短信内容</label>
                            <textarea class="form-textarea" id="smsMessage" placeholder="输入短信内容..." oninput="app.modemManager.updateSmsCounter()"></textarea>
                        </div>
                        <div id="smsCounter" class="sms-counter">
                            <span>字符数: 0 / 160</span> | <span>短信条数: 1</span> | <span>编码: GSM 7-bit</span>
                        </div>
                    </div>
                </div>

            </div>

            <!-- 短信存储管理 -->
            <div id="smsdbTab" class="tab-content">

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">短信存储管理</h2>
                        <div>
                            <button class="btn btn-secondary" onclick="app.smsdbManager.listSmsdb()">刷新</button>
                            <button class="btn btn-success" onclick="app.smsdbManager.syncCurrentModemSms()">同步</button>
                            <button class="btn btn-danger" onclick="app.smsdbManager.deleteSelectedSmsdb()">删除</button>
                        </div>
                    </div>

                    <div class="card-body">
                        <!-- 设置 -->
                        <div class="filter-section">
                            <label class="form-checkbox">
                                <input type="checkbox" id="smsdbEnabled" onchange="app.settingManager.updateSmsdbSettings()">
                                <span>启用数据库存储</span>
                            </label>
                        </div>

                        <!-- 搜索过滤 -->
                        <div class="filter-section">
                            <input type="text" class="form-input" id="smsdbFilterSendNumber" placeholder="发送号码过滤">
                            <select class="form-select" id="smsdbFilterDirection">
                                <option value="">所有方向</option>
                                <option value="in">接收</option>
                                <option value="out">发送</option>
                            </select>
                            <input type="date" class="form-input" id="smsdbFilterStartDate" placeholder="开始日期">
                            <input type="date" class="form-input" id="smsdbFilterEndDate" placeholder="结束日期">
                            <button class="btn btn-primary" onclick="app.smsdbManager.listSmsdb()">搜索</button>
                        </div>

                        <!-- 短信列表 -->
                        <div class="scroll-container mt-1">
                            <table class="table smsdb-table" id="smsdbTable">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="smsdbCheckAll" onchange="app.smsdbManager.toggleCheckAll()"></th>
                                        <th>方向</th>
                                        <th>发送号码</th>
                                        <th>接收号码</th>
                                        <th>内容</th>
                                        <th>接收时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="smsdbList">
                                    <!-- 短信存储列表项模板 -->
                                    <tr id="smsdbItem">
                                        <td><input type="checkbox" value="{id}" onchange="app.smsdbManager.toggleSmsdbSelection({id})"></td>
                                        <td>{direction}</td>
                                        <td>{send_number}</td>
                                        <td>{receive_number}</td>
                                        <td>{content}</td>
                                        <td>{receive_time}</td>
                                        <td>
                                            <button class="btn btn-small btn-secondary" onclick="app.smsdbManager.copySmsdb(`{content}`)">复制</button>
                                            <button class="btn btn-small btn-danger" onclick="app.smsdbManager.deleteSmsdb({id})">删除</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- 分页 -->
                        <div class="pagination">
                            <span class="pagination-info" id="smsdbPageInfo">第 1 页</span>
                            <span class="flex-auto"></span>
                            <button class="btn btn-secondary" onclick="app.smsdbManager.smsdbPrevPage()">上一页</button>
                            <button class="btn btn-secondary" onclick="app.smsdbManager.smsdbNextPage()">下一页</button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Webhook配置 -->
            <div id="webhookTab" class="tab-content">

                <!-- Webhook列表 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Webhook 配置管理</h2>
                        <div>
                            <button class="btn btn-secondary" onclick="app.webhookManager.listWebhooks()">刷新列表</button>
                        </div>
                    </div>

                    <div class="card-body">
                        <!-- 设置 -->
                        <div class="filter-section">
                            <label class="form-checkbox">
                                <input type="checkbox" id="webhookEnabled" onchange="app.settingManager.updateWebhookSettings()">
                                <span>启用 Webhook 功能</span>
                            </label>
                        </div>

                        <!-- Webhook列表 -->
                        <div class="scroll-container mt-1">
                            <table class="table webhook-table">
                                <thead>
                                    <tr>
                                        <th>名称</th>
                                        <th>URL</th>
                                        <th>状态</th>
                                        <th>创建时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="webhookList">
                                    <!-- Webhook列表项模板 -->
                                    <tr id="webhookItem">
                                        <td>{name}</td>
                                        <td>{url}</td>
                                        <td>{enabled}</td>
                                        <td>{created_at}</td>
                                        <td>
                                            <button class="btn btn-small btn-success" onclick="app.webhookManager.editWebhook({id})">编辑</button>
                                            <button class="btn btn-small btn-danger" onclick="app.webhookManager.deleteWebhook({id})">删除</button>
                                            <button class="btn btn-small btn-secondary" onclick="app.webhookManager.testWebhook({id})">测试</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Webhook编辑表单 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title" id="webhookFormTitle">创建 Webhook</h2>
                        <div>
                            <button class="btn btn-primary" onclick="app.webhookManager.saveWebhook()">保存配置</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">名称</label>
                            <input type="text" class="form-input" id="webhookName" placeholder="Webhook名称">
                        </div>
                        <div class="form-group">
                            <label class="form-label">预设模板</label>
                            <select class="form-input" id="webhookTemplateSelect" onchange="app.webhookManager.applyPresetTemplate()">
                                <option value="custom">自定义</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">URL</label>
                            <input type="text" class="form-input" id="webhookURL" placeholder="https://example.com/webhook">
                        </div>
                        <div class="form-group">
                            <label class="form-label">模板 (JSON)</label>
                            <textarea class="form-textarea" id="webhookTemplate" rows="10" placeholder='{"event": "sms_received", "data": {"content": "{{content}}", "send_number": "{{send_number}}"}}'></textarea>
                            <small class="text-small-secondary">可用变量: {{content}}, {{send_number}}, {{receive_number}}, {{receive_time}}, {{sms_ids}}, {{direction}}</small>
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox">
                                <input type="checkbox" id="webhookEnabledCheckbox">
                                <span>启用</span>
                            </label>
                        </div>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <!-- 日志面板 -->
    <div id="logPanel" class="logger expanded">
        <div class="logger-header">
            <span class="logger-title">📋 系统日志</span>
            <div class="logger-controls">
                <button class="log-btn" title="清空日志" onclick="app.logger.clear()">🗑️</button>
                <button class="log-btn" title="收缩/展开" onclick="app.logger.toggle()">⬇️</button>
            </div>
        </div>
        <div class="logger-content">
            <div class="log-container" id="logContainer"></div>
        </div>
        <div class="logger-resize-handle" title="拖动调整大小">⋰</div>
    </div>

    <script type="module" src="js/main.js"></script>
</body>

</html>